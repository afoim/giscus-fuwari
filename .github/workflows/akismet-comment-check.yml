name: Akismet Discussion Comment Checker

on:
  discussion_comment:
    types: [created]

jobs:
  check-akismet:
    runs-on: ubuntu-latest
    steps:
      - name: Check if comment is spam
        uses: actions/github-script@v7
        env:
          AKISMET_API_KEY: ${{ secrets.AKISMET_API_KEY }}
          GITHUB_TOKEN_BOT: ${{ secrets.GH_TOKEN }}
        with:
          script: |
            const axios = require('axios');

            const comment = context.payload.comment;
            const discussion = context.payload.discussion;

            const pathname = discussion.title || '';
            const author = comment.author?.login || 'anonymous';
            const user_ip = "127.0.0.1"; // GitHub ‰∏çÊèê‰æõÁúüÂÆû IPÔºåÂè™ËÉΩÊ®°Êãü
            const user_agent = "GitHubActionBot/1.0";

            const akismetCheck = async () => {
              const form = new URLSearchParams();
              form.append('blog', 'https://yourdomain.com');
              form.append('user_ip', user_ip);
              form.append('user_agent', user_agent);
              form.append('comment_type', 'comment');
              form.append('comment_author', author);
              form.append('comment_content', comment.body || '');

              const akismetUrl = `https://${process.env.AKISMET_API_KEY}.rest.akismet.com/1.1/comment-check`;
              const res = await axios.post(akismetUrl, form, {
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              });

              return res.data === 'true';
            };

            const isSpam = await akismetCheck();

            if (isSpam) {
              console.log('üö´ Detected spam comment. Deleting...');
              const deleteUrl = comment.node_id;

              // Use GitHub REST API to delete comment
              const fetch = require('node-fetch');
              const auth = process.env.GITHUB_TOKEN_BOT;

              const result = await fetch(comment.url, {
                method: 'DELETE',
                headers: {
                  Authorization: `token ${auth}`,
                  'User-Agent': 'AkismetBot',
                  Accept: 'application/vnd.github+json',
                },
              });

              if (result.status === 204) {
                console.log('‚úÖ Comment deleted');
              } else {
                console.error('‚ùå Failed to delete comment:', result.status);
              }
            } else {
              console.log('‚úÖ Comment is clean');
            }
