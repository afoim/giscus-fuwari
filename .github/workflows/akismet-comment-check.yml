name: Akismet Discussion Comment Checker
on:
  discussion_comment:
    types: [created]

jobs:
  check-akismet:
    runs-on: ubuntu-latest
    steps:
      - name: Check if comment is spam
        env:
          AKISMET_API_KEY: ${{ secrets.AKISMET_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          COMMENT_URL: ${{ github.event.comment.url }}
          COMMENT_HTML_URL: ${{ github.event.comment.html_url }}
          DISCUSSION_TITLE: ${{ github.event.discussion.title }}
          DISCUSSION_NUMBER: ${{ github.event.discussion.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          set -uo pipefail  # ç§»é™¤ -e è®©è„šæœ¬ç»§ç»­æ‰§è¡Œå³ä½¿æœ‰é”™è¯¯
          
          echo "ğŸ” Checking comment from ${COMMENT_AUTHOR} for spam..."
          echo "Comment preview: ${COMMENT_BODY:0:100}..."
          
          # å‡†å¤‡ Akismet API è¯·æ±‚æ•°æ®
          AKISMET_URL="https://${AKISMET_API_KEY}.rest.akismet.com/1.1/comment-check"
          
          # ä½¿ç”¨ curl æ£€æŸ¥åƒåœ¾è¯„è®º
          AKISMET_RESPONSE=$(curl -s -X POST "$AKISMET_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -H "User-Agent: GitHubActionBot/1.0" \
            --data-urlencode "blog=https://github.com/${REPO_OWNER}/${REPO_NAME}" \
            --data-urlencode "user_ip=127.0.0.1" \
            --data-urlencode "user_agent=GitHubActionBot/1.0" \
            --data-urlencode "comment_type=comment" \
            --data-urlencode "comment_author=${COMMENT_AUTHOR}" \
            --data-urlencode "comment_content=${COMMENT_BODY}" \
            2>/dev/null || echo "false")
          
          echo "Akismet response: ${AKISMET_RESPONSE}"
          
          if [ "$AKISMET_RESPONSE" = "true" ]; then
            echo "ğŸš« Spam detected! Taking action..."
            
            # é¦–å…ˆæ£€æŸ¥æˆ‘ä»¬èƒ½å¦è®¿é—®è¯„è®º
            echo "Checking comment accessibility..."
            COMMENT_CHECK=$(curl -s -w "%{http_code}" -o /tmp/comment_check.json \
              -H "Authorization: token ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              -H "User-Agent: AkismetBot/1.0" \
              "$COMMENT_URL")
            
            echo "Comment check response: ${COMMENT_CHECK}"
            
            if [ "$COMMENT_CHECK" = "200" ]; then
              echo "Comment accessible, attempting deletion..."
              
              # å°è¯•åˆ é™¤è¯„è®º
              DELETE_RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/delete_response.txt \
                -X DELETE "$COMMENT_URL" \
                -H "Authorization: token ${GITHUB_TOKEN}" \
                -H "Accept: application/vnd.github+json" \
                -H "User-Agent: AkismetBot/1.0" \
                2>/dev/null || echo "000")
              
              echo "Delete response code: ${DELETE_RESPONSE}"
              
              if [ "$DELETE_RESPONSE" = "204" ]; then
                echo "âœ… Spam comment deleted successfully"
                ACTION_TAKEN="deleted"
              else
                echo "âŒ Failed to delete comment (HTTP ${DELETE_RESPONSE})"
                if [ -f /tmp/delete_response.txt ]; then
                  echo "Error details:"
                  cat /tmp/delete_response.txt
                fi
                ACTION_TAKEN="delete_failed"
              fi
            else
              echo "âŒ Cannot access comment (HTTP ${COMMENT_CHECK})"
              ACTION_TAKEN="access_failed"
            fi
            
            # åˆ›å»ºæŠ¥å‘Š issueï¼ˆæ— è®ºåˆ é™¤æ˜¯å¦æˆåŠŸï¼‰
            echo "Creating spam report issue..."
            
            if [ "$ACTION_TAKEN" = "deleted" ]; then
              ISSUE_TITLE="[Auto] Spam Comment Removed from Discussion: ${DISCUSSION_TITLE}"
              ISSUE_BODY="ğŸ¤– **Spam Detection Report**

Akismet detected and successfully removed a spam comment from @${COMMENT_AUTHOR}.

**Discussion**: ${DISCUSSION_TITLE}
**Original Comment URL**: ${COMMENT_HTML_URL}
**Detection Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

**Content Preview** (first 200 chars):
\`\`\`
${COMMENT_BODY:0:200}$([ ${#COMMENT_BODY} -gt 200 ] && echo "...")
\`\`\`

_This issue was created automatically by the spam detection system._"
              LABELS='["spam", "automated-moderation", "resolved"]'
            else
              ISSUE_TITLE="[URGENT] Spam Detected - Manual Review Required: ${DISCUSSION_TITLE}"
              ISSUE_BODY="âš ï¸ **Spam Detection Alert**

Akismet detected spam content from @${COMMENT_AUTHOR}, but automatic deletion failed.

**Discussion**: ${DISCUSSION_TITLE}
**Comment URL**: ${COMMENT_HTML_URL}
**Detection Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
**Action Status**: ${ACTION_TAKEN}

**Action Required**: Please manually review and moderate this comment.

**Content Preview** (first 200 chars):
\`\`\`
${COMMENT_BODY:0:200}$([ ${#COMMENT_BODY} -gt 200 ] && echo "...")
\`\`\`

_This alert was generated automatically. Manual intervention required._"
              LABELS='["spam", "manual-review-required", "urgent"]'
            fi
            
            # åˆ›å»º issue
            ISSUE_RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/issue_response.json \
              -X POST "https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues" \
              -H "Authorization: token ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              -d "{
                \"title\": $(echo "$ISSUE_TITLE" | jq -Rs .),
                \"body\": $(echo "$ISSUE_BODY" | jq -Rs .),
                \"labels\": $LABELS
              }" 2>/dev/null || echo "000")
            
            if [ "${ISSUE_RESPONSE: -3}" = "201" ]; then
              echo "ğŸ“§ Spam report issue created successfully"
            else
              echo "âŒ Failed to create issue (HTTP ${ISSUE_RESPONSE})"
              if [ -f /tmp/issue_response.json ]; then
                echo "Issue creation error details:"
                cat /tmp/issue_response.json
              fi
            fi
            
          else
            echo "âœ… Comment passed spam check"
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f /tmp/comment_check.json /tmp/delete_response.txt /tmp/issue_response.json
          
          echo "ğŸ Spam check workflow completed"
